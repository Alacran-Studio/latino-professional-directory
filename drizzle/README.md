# Drizzle ORM Setup for Next.js Project

This directory contains the configuration and migration files for Drizzle ORM, used to manage the PostgreSQL database in this Next.js project.

## Overview

Drizzle ORM is a lightweight TypeScript ORM that provides a clean and type-safe interface to interact with your PostgreSQL database. This setup ensures that database interactions within the project are consistent, reliable, and maintainable.

### Folder Structure

- **`drizzle.config.ts`**: This file contains the configuration for connecting to the PostgreSQL database using Drizzle ORM. It exports a configuration object using `defineConfig` from `drizzle-kit` and connects to the database using the provided environment variables.

- **`migrations/`**: This directory stores all the database migration files generated by Drizzle. Each migration file contains the SQL commands necessary to modify the database schema, ensuring that changes to the database structure are version-controlled and reproducible.

- **`schema.ts`**: This file is where database schemas (models) are defined using Drizzle's TypeScript interface. Each schema corresponds to a table in the PostgreSQL database and defines the structure and types of the table's columns.

## Setting Up Drizzle

> [!IMPORTANT]
> These instructions are for setting up your database from scratch after you
> installed PostgreSQL via Homebrew. If you're using something like Supabase,
> please make your `.env` file reflect those values instead.

Before using Drizzle, ensure that you have correctly configured your environment
variables in the `.env` file:

```
POSTGRES_HOST=localhost
POSTGRES_DATABASE=lpdd
POSTGRES_PORT=5432
POSTGRES_USER=lpdd
POSTGRES_PASSWORD=lpdd
```

These variables are used to establish a connection with the PostgreSQL database.

<details open>
<summary>⚠️  Need help?</summary>

After installing PostgreSQL, you may not know the values for some of the
variables mentioned above. It's also possible that you don't have a PostgreSQL
user, password, nor database setup.

To setup these values, you can run the following commands to attach to your
local fresh PostgreSQL installation and run some SQL commands to create the
role, password, and database with the proper permissions setup.

**Connect to your fresh PostgreSQL installation**

```sh
psql postgres
```

**Create the role (user) with a password**

```sql
CREATE ROLE lpdd WITH LOGIN PASSWORD 'lpdd';
```

**Add the CREATEDB attribute to your new role**

```sql
ALTER ROLE lpdd CREATEDB;
```

**Create the database**

```sql
CREATE DATABASE lpdd;
```

**Add the privileges on the `lpdd` database to the the `lpdd` role**

```sql
GRANT ALL PRIVILEGES ON DATABASE lpdd TO lpdd;
```

</details>

After setting up your database and `.env` file correctly, run the following
commands to migrate your database and seed the database.

```sh
npm run migration:apply db:seed
```

## Running Migrations

Drizzle ORM supports database migrations, allowing you to apply schema changes in a controlled manner.

### 1. Generate a New Migration

When you need to make changes to the database schema (e.g., adding a new table or modifying a column), you can generate a new migration file using the following npm script:

```
npm run migration:generate --name <migration-name>
```

Replace `<migration-name>` with a descriptive name for the migration, such as `add-users-table` or `modify-email-column`. This command will generate a new migration file in the `migrations/` directory.

### 2. Apply Migrations

Once a migration has been generated, you can apply it to the database using the following npm script:

```
npm run migration:apply
```

This command will execute all pending migrations in the correct order, ensuring that your database schema is up to date.

## Example Usage

Here’s an example of how you might define a schema in `schema.ts`:

```
import { integer, text, timestamp, Table } from 'drizzle-orm-pg';

export const users = Table('users', {
  id: integer('id').primaryKey().autoIncrement(),
  name: text('name').notNull(),
  email: text('email').unique().notNull(),
  createdAt: timestamp('created_at').default('now()'),
});
```

You can then use this schema in your API routes or pages to interact with the database.

```
import db from '../drizzle.config';
import { users } from './schema';

// Example: Fetching all users
const allUsers = await db.select(users).all();
```

## Drizzle Configuration Example

Here’s an example of what the `drizzle.config.ts` file might look like:

```
import './drizzle/envConfig';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './drizzle/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    host: process.env.POSTGRES_HOST!,
    database: process.env.POSTGRES_DATABASE!,
    port: Number(process.env.POSTGRES_PORT!),
    user: process.env.POSTGRES_USER!,
    password: process.env.POSTGRES_PASSWORD!,

    /* NOTE: Alternative approach */
    // url: process.env.POSTGRES_DB
  },
});

```

## Additional Notes

- **Keep Migrations in Sync**: Always ensure that your migrations are up to date before deploying your application to avoid potential database schema conflicts.
- **Environment Variables**: Make sure your environment variables are correctly set up, especially in production environments.

For more details on Drizzle ORM, visit the official [Drizzle ORM documentation](https://drizzle.team/).

---

This README provides an overview of the Drizzle ORM setup within this project and instructions for managing database migrations.
